<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYN Signage Player</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Styles remain the same */
    </style>
</head>
<body>
    <script>
    const SUPABASE_URL = 'https://hlpihjisaxijhimyufaq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhscGloamlzYXhpamhpbXl1ZmFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODEzMDQsImV4cCI6MjA3MTY1NzMwNH0.ecu2jbGDD6Qb9ct6UR5z2PBaxkvv2OBP5KOmcj1ujHE';

    const anonSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ... other variables ...

    // ... generateUUID() function is the same ...

    async function initializePlayer() {
        let deviceId = localStorage.getItem('ayn_device_id');
        const deviceJwt = localStorage.getItem('ayn_device_jwt');

        if (deviceJwt) {
            startPlayback(deviceId, deviceJwt);
            return;
        }

        if (!deviceId) {
            deviceId = generateUUID();
            localStorage.setItem('ayn_device_id', deviceId);
        }

        const { data: existingCode, error: checkError } = await anonSupabase.rpc('get_pairing_code', { device_id_in: deviceId });
        if (checkError) { /* ... error handling ... */ }

        let pairingCode = existingCode;
        if (!pairingCode) {
            pairingCode = deviceId.slice(-10).toUpperCase();
            const { error: registerError } = await anonSupabase.rpc('register_unclaimed_device', { device_id_in: deviceId, pairing_code_in: pairingCode });
            if (registerError) { /* ... error handling ... */ }
        }
        
        document.getElementById('pairing-code-display').textContent = pairingCode;
        startPollingForClaim(deviceId);
    }

    function startPollingForClaim(deviceId) {
        showView('pairing-view');
        pollingInterval = setInterval(async () => {
            // --- NEW SIMPLIFIED LOGIC ---
            // We now check for the JWT directly in the screens table.
            const { data, error } = await anonSupabase.from('screens').select('device_jwt').eq('id', deviceId).single();

            if (data && data.device_jwt) {
                console.log("Device has been claimed and JWT is available!");
                clearInterval(pollingInterval);
                localStorage.setItem('ayn_device_jwt', data.device_jwt);
                startPlayback(deviceId, data.device_jwt);
            }
        }, 5000);
    }

    // startPlayback() and other functions remain the same
    // ...
    initializePlayer();
</script>
</body>
</html>
